# Generated by LakehousePlumber
# Pipeline: gold_load
# FlowGroup: sales_summary_monthly_mv
# Generated: 2025-07-14T15:55:47.811093

from pyspark.sql import DataFrame
import dlt

# Pipeline Configuration
PIPELINE_ID = "sales_summary_monthly_mv"
PIPELINE_GROUP = "gold_load"

# ============================================================================
# SOURCE VIEWS
# ============================================================================


@dlt.view()
def v_sales_summary_monthly_mv_sql():
    """SQL source: sales_summary_monthly_mv_sql"""
    df = spark.sql(
        """SELECT
  YEAR(order_date) as year,
  MONTH(order_date) as month,
  SUM(total_price) as monthly_revenue,
  COUNT(DISTINCT o.order_id) as monthly_orders,
  COUNT(DISTINCT o.customer_id) as monthly_customers,
  AVG(total_price) as avg_monthly_order_value
FROM acmi_edw_dev.edw_silver.orders_fct o
GROUP BY YEAR(order_date), MONTH(order_date)
"""
    )

    return df


# ============================================================================
# TARGET TABLES
# ============================================================================


@dlt.table(
    name="acmi_edw_dev.edw_gold.sales_summary_monthly_mv",
    comment="Materialized view: sales_summary_monthly_mv",
    table_properties={},
)
def sales_summary_monthly_mv():
    """Write to acmi_edw_dev.edw_gold.sales_summary_monthly_mv from multiple sources"""
    # Materialized views use batch processing
    df = spark.read.table("v_sales_summary_monthly_mv_sql")

    return df
